# TdGD Introgression Mapping - Pipeline Description
## Retrieve sequencing data
**1. download_ncbi.sh:** Download SRA files from NCBI
- INPUT: Hard-coded list of SRA ids
- OUTPUT: SRA files
- Uses sratoolkit activated within a conda environment to run prefetch
***
**2. validate_sra.sh:** Validate SRA file integrity
- INPUT: A single SRA file
- OUTPUT: Console output/logs confirming file validation
- Uses sratoolkit activated within a conda environment to run vdb-validate
***
## Convert to FASTQ and prepare for alignment
**3. convert_single_sra.sh:** Convert a single SRA file to FASTQ format
- INPUT: A single SRA file specified as a command-line argument
- OUTPUT: Paired-end FASTQ files
- Uses sratoolkit activated within a conda environment to run fasterq-dump
***
**4. fastp_QC_single.sh:** Run quality control on paired-end FASTQ files
- INPUT: Paired-end FASTQ files from the input directory specified via a sample prefix command-line argument
- OUTPUT:
  - Quality-controlled FASTQ files (trimmed/filtered paired-end files and unpaired reads) in the output directory
  - An HTML report summarizing the QC results
- Uses fastp installed in a conda environment
***
**5. bwaIndex.sh:** Generate BWA index files for a reference genome
- INPUT: Reference genome file (.fna)
- OUTPUT: BWA index files with various extensions stored in the specified output directory
- Uses BWA to build the reference index using the bwtsw indexing algorithm
***
## Obtain BAM files from alignment and prepare for variant calling
**6. align.sh:** Align paired-end FASTQ files, sort, mark duplicates, and apply mapping quality filters
- INPUT:
  - Paired-end FASTQ files in the designated FASTQ directory
  - A reference genome located in the REF directory
  - Command-line arguments of mapping quality thresholds and base name/sample ID (for file naming and read group info)
- OUTPUT:
  - A SAM file from the BWA alignment
  - A sorted BAM file produced by Picard SortSam
  - A duplicate-marked BAM file with corresponding duplication metrics generated by Picard MarkDuplicates
  - For each specified mapping quality threshold, a filtered BAM file is generated using SAMtools
- PARAMETER MODIFICATION: Specify mapping quality thresholds as command-line arguments (default is 40)
- Uses BWA for aligning reads to the reference genome, Picard for sorting SAM files and marking duplicates, SAMtools for filtering alignments based on mapping quality
***
**7a. MQ_comparison.sh:** Compare filtered BAM files across different mapping quality thresholds
- INPUT: BAM files in the input directory that have been filtered with different MQ thresholds (sample ID provided as a command-line argument)
- OUTPUT: 4 output files in designated MQ_comparison directory for each BAM file
  - Stats file containing alignment statistics from bamtools stats
  - Depth file containing per base depth calculated using samtools depth
  - Average depth file containing computed average coverage (AWK command)
  - Depth distribution file containing the distribution of depth levels across the genome (AWK with sorting)
- Uses SAMtools for calculating per-base coverage, BamTools for extracting alignment statistics, AWK for processing depth data to compute depth average and distribution of depth across genomic positions

**7b. depth.sh:** Compute the maximum depth from per-base depth files
- INPUT: A directory containing depth files that list per-base depth data
- OUTPUT: Console output displaying the processed file and its maximum depth value
- Uses standard Unix tools (Bash, AWK, find, sort)
***
**8a. merge_bam.sh:** Merge multiple BAM files from the same sample genotype into a single BAM file
- INPUT: Listed BAM files in the input directory
- OUTPUT: A merged BAM file stored in the output directory
- Uses SAMtools to merge BAM files using samtools merge command

**8b. RG_change.sh:** Update read groups in BAM files to a uniform value
- INPUT: Command-line arguments for the file identifier used to match BAM files in the input directory and the uniform read group value to assign
- OUTPUT: Updated BAM files with new read group information in the output directory
- Uses Picard for updating read group information via AddOrReplaceReadGroups
***
**9. bamIndex.sh:** Index BAM file
- INPUT: A BAM file name provided as a command-line argument
- OUTPUT: A CSI index file generated for the BAM file stored in the output directory
- Uses SAMtools for indexing the BAM file via samtools index -c
***
## Variant calling and filtering
**10a. VariantCall.sh:** Call variants by chromosome, per subgenome
- INPUT:
  - File with a list of full paths to BAM files
  - Reference genome FASTA
- OUTPUT: A VCF file per chromosome and subgenome
- PARAMETER MODIFICATION: Modify the BAM depth threshold as desired
- Uses BCFtools mpileup for variant calling

**10b. vcf_arrayConcordance.sh:** Call variants by chromosome, per subgenome, at targeted sites based off progeny array data
- INPUT: 
  - File with a list of full paths to BAM files
  - List of target positions
  - Reference genome FASTA
- OUTPUT: A VCF file across all target array sites
- PARAMETER MODIFICATION: Modify the BAM depth threshold as desired
- Uses BCFtools to call variants with mpileup at targeted sites
***










